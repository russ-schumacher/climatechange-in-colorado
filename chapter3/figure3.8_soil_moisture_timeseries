%%This code will first show users how to download Western Land Data Assimilation Systems data, and then use the soil moisture data to create the timeseries shown in figure 3.8

%The first portion is a shell script used to download WLDAS data from 1980-2022. Note: You will need to create a nasaearthdata account, and set your cookies before downloading

#sdf!/bin/bash



y=(1980 1981 1982 1983 1984 1985 1986 1987 1988 1989 1990 1991 1992 1993 1994 1995 1996 1997 1998 1999 2000 2001 2002 2003 2004 2005 2006 2007 2008 
2009 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 2020 2021 2022)
m=(01 02 03 04 05 06 07 08 09 10 11 12)
d=(01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31)

adrs=https://portal.nccs.nasa.gov/datashare/WLDAS/wldas_domain
end=0000.d01.nc
star=LIS_HIST_

for i in {0..42}; do
        for j in {0..11}; do
                if ((j == 1)); then
                        for k in {0..0}; do
                                wget --load-cookies ~/.urs_cookies --save-cookies ~/.urs_cookies --auth-no-challenge=on --keep-session-cookies 
                                --no-check-certificate --content-disposition $adrs/${y[$i]}${m[$j]}/$star${y[$i]}${m[$j]}${d[$k]}$end
                        done
                elif ((j == 3)) || ((j == 5)) || ((j == 8)) || ((j == 10)); then
                        for k in {0..0}; do
                                wget --load-cookies ~/.urs_cookies --save-cookies ~/.urs_cookies --auth-no-challenge=on --keep-session-cookies 
                                --no-check-certificate --content-disposition $adrs/${y[$i]}${m[$j]}/$star${y[$i]}${m[$j]}${d[$k]}$end
                        done
                else
                        for k in {0..0}; do
                                wget --load-cookies ~/.urs_cookies --save-cookies ~/.urs_cookies --auth-no-challenge=on --keep-session-cookies 
                                --no-check-certificate --content-disposition $adrs/${y[$i]}${m[$j]}/$star${y[$i]}${m[$j]}${d[$k]}$end
                        done
                fi
        done
done

%Now for the figure analysis with MATLAB

%first, read the data from the files you gathered. 

%This script will be used to generate a timeseries of 0-2meter soil
%moisture volumetric water content using Western Land Data Assimilation
%Systems data averaged across the Colorado high country

syears = ['1980';'1981';'1982';'1983';'1984';'1985';'1986';'1987';'1988';'1989';...
    '1990';'1991';'1992';'1993';'1994';'1995';'1996';'1997';'1998';'1999';...
    '2000';'2001';'2002';'2003';'2004';'2005';'2006';'2007';'2008';'2009';...
    '2010';'2011';'2012';'2013';'2014';'2015';'2016';'2017';'2018';'2019';...
    '2020';'2021';'2022'];


WLDAS = zeros(414,718,12,43,5); %NOAH soil moisture (lat x lon x month x year x depth)

for i = 1:43 %current
    for j = 1:12
            file1 = sprintf('I:\\WLDAS\\LIS_HIST_%s%s010000.d01.nc',syears(i,:),mo(j,:));
            blarg = ncread(file1,'SoilMoist_tavg');
            blarg = squeeze(blarg(1581:2298,1189:1602,:));
            blarg = permute(blarg,[2 1 3]);
            WLDAS(:,:,j,i,1) = blarg(:,:,1); %0-10cm
            WLDAS(:,:,j,i,2) = blarg(:,:,2); %10-40cm
            WLDAS(:,:,j,i,3) = blarg(:,:,3); %40-100cm
            WLDAS(:,:,j,i,4) = blarg(:,:,4); %100-200cm
            WLDAS(:,:,j,i,5) = (0.05*blarg(:,:,1) +...
                0.15*blarg(:,:,2) + 0.35*blarg(:,:,3) +...
                0.5*blarg(:,:,4))/1; %vertically integrated
            disp(j)
    end
    disp(i)
end

%convert to PRISM grid (used in figure 2.12 of this repository)

WLDTP = zeros(length(cololats),length(cololons),12,42,5);

for i = 1:length(cololats)
    for j = 1:length(cololons)
        dist = 1000000;
        for x = 1:3:414
            for y = 1:3:718
                if distance([cololats(i) cololons(j)],[plat(x,1) plon(1,y)]) < dist
                    dist = distance([cololats(i) cololons(j)],[plat(x,1) plon(1,y)]);
                    WLDTP(i,j,:,:,:) = WLDAS(x,y,:,:,:);
                end
            end
        end
        disp(j)
    end
    disp(i)
end

ecount = 0;
for i = 1:length(cololats)
    for j = 1:length(cololons)
        if elv(i,j) > 2400
            ecount = ecount + 1;
        end
    end
end

SMtrends = zeros(42,12,5);
for i = 1:length(cololats)
    for j = 1:length(cololons)
        if elv(i,j) > 2400
            for k = 1:42
                for m = 1:12
                    for n = 1:5
                        SMtrends(k,m,n) = SMtrends(k,m,n) + WLDTP(i,j,m,k,n)/ecount;
                    end
                end
            end
        end
    end
end


figure; plot(100*SMts(:,5),'linewidth',2,'color','b')
hold on
grid on
set(gca,'xtick',1:60:505,'xticklabel',['1980';'1985';'1990';'1995';'2000';'2005';'2010';'2015';'2020'])
set(gca,'fontsize',12)
xlabel('Year','fontsize',12)
ylabel('Soil Moisture (% by volume)')
title('Colorado Soil Moisture Above 8000f')
bl = ['1980';'1985';'1990';'1995';'2000';'2005';'2010';'2015';'2020'];
f = figure; subplot(311), plot(SMts)
f.Position = [100 100 700 700];
grid on
axis([1 1032 450 600])
set(gca,'xtick',blarg,'xticklabel',bl)
xlabel('Year','fontsize',12)
ylabel('VWC (mm)','fontsize',12)
title('Colorado Volumetric Water Content Above 8000ft','fontsize',14)
set(gca,'fontsize',10)
pos = get(gca, 'Position');
pos(1) = 0.1;
pos(3) = 0.85;
set(gca, 'Position', pos)
pol = polyfit(1:1032,SMts,1);
pfline = linspace(0,0,1032);
for i = 1:1032
    pfline(i) = pol(2) + i*pol(1);
end
plot(pfline,'color',[0.5 0.5 0.5])
